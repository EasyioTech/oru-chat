# nginx.conf - Production configuration for orutest.site
events {
    worker_connections 1024;
}

http {
    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # Enable Brotli compression (if available)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    upstream app_server {
        server app:3000;
    }

    upstream centrifugo_server {
        server centrifugo:8000;
    }

    # HTTP Server - Redirect to HTTPS
    server {
        listen 80;
        server_name orutest.site www.orutest.site;

        # Let's Encrypt ACME challenge
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Redirect all HTTP traffic to HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    # HTTPS Server
    server {
        listen 443 ssl;
        http2 on;
        server_name orutest.site www.orutest.site;

        # SSL Certificates (will be generated by certbot)
        ssl_certificate /etc/letsencrypt/live/orutest.site/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/orutest.site/privkey.pem;

        # SSL Configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # HSTS (Optional - uncomment after testing)
        # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # Increase client body size for file uploads (25MB limit)
        client_max_body_size 50M;

        # Main application proxy
        location / {
            proxy_pass http://app_server;
            proxy_http_version 1.1;
            
            # WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # Cookie handling - ensure cookies work with session auth
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / "/; HttpOnly; Secure; SameSite=Lax";
            
            # Cache bypass
            proxy_cache_bypass $http_upgrade;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check endpoint (no auth required)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API endpoints (ensure they work with CORS if needed)
        location /api/ {
            proxy_pass http://app_server;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cookie handling for API auth
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            
            # Timeouts for API
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Centrifugo WebSocket endpoint
        location /connection/websocket {
            proxy_pass http://centrifugo_server;
            proxy_http_version 1.1;
            
            # WebSocket upgrade (REQUIRED)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # No cookie forwarding needed (Centrifugo uses tokens)
            
            # Disable buffering
            proxy_buffering off;
            proxy_cache off;
            
            # Longer timeout for persistent connections
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 10s;
        }

        # Centrifugo HTTP API (for server-side publishing)
        location /api/centrifugo {
            proxy_pass http://centrifugo_server/api;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTPS Server on Port 3008 (Custom requirement)
    server {
        listen 3008 ssl;
        http2 on;
        server_name orutest.site www.orutest.site;

        # SSL Certificates
        ssl_certificate /etc/letsencrypt/live/orutest.site/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/orutest.site/privkey.pem;

        # SSL Configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # Increase client body size
        client_max_body_size 50M;

        # Main application proxy
        location / {
            proxy_pass http://app_server;
            proxy_http_version 1.1;
            
            # WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # Cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            proxy_cookie_path / "/; HttpOnly; Secure; SameSite=Lax";
            
            # Cache bypass
            proxy_cache_bypass $http_upgrade;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # API endpoints
        location /api/ {
            proxy_pass http://app_server;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cookie handling
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # Centrifugo WebSocket endpoint
        location /connection/websocket {
            proxy_pass http://centrifugo_server;
            proxy_http_version 1.1;
            
            # WebSocket upgrade (REQUIRED)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # No cookie forwarding needed (Centrifugo uses tokens)
            
            # Disable buffering
            proxy_buffering off;
            proxy_cache off;
            
            # Longer timeout for persistent connections
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 10s;
        }

        # Centrifugo HTTP API (for server-side publishing)
        location /api/centrifugo {
            proxy_pass http://centrifugo_server/api;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
